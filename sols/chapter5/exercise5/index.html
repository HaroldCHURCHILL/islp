<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">   
    <link rel="shortcut icon" href="../../../img/favicon.ico">

    <title></title>

    <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../../css/base.css" rel="stylesheet">
    <link href="../../../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="../../..">Statistical Learning with Python</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">2 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../chapter2/exercise1/">2.1</a>
</li>

                        
                            
<li >
    <a href="../../chapter2/exercise2/">2.2</a>
</li>

                        
                            
<li >
    <a href="../../chapter2/exercise3/">2.3</a>
</li>

                        
                            
<li >
    <a href="../../chapter2/exercise4/">2.4</a>
</li>

                        
                            
<li >
    <a href="../../chapter2/exercise5/">2.5</a>
</li>

                        
                            
<li >
    <a href="../../chapter2/exercise6/">2.6</a>
</li>

                        
                            
<li >
    <a href="../../chapter2/exercise7/">2.7</a>
</li>

                        
                            
<li >
    <a href="../../chapter2/exercise8/">2.8</a>
</li>

                        
                            
<li >
    <a href="../../chapter2/exercise9/">2.9</a>
</li>

                        
                            
<li >
    <a href="../../chapter2/exercise10/">2.10</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">3 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../chapter3/exercise1/">3.1</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise2/">3.2</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise3/">3.3</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise4/">3.4</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise5/">3.5</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise6/">3.6</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise7/">3.7</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise8/">3.8</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise9/">3.9</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise10/">3.10</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise11/">3.11</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise12/">3.12</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise13/">3.13</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise14/">3.14</a>
</li>

                        
                            
<li >
    <a href="../../chapter3/exercise15/">3.15</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">4 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../chapter4/exercise1/">4.1</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise2/">4.2</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise3/">4.3</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise4/">4.4</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise5/">4.5</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise6/">4.6</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise7/">4.7</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise8/">4.8</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise9/">4.9</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise10/">4.10</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise11/">4.11</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise12/">4.12</a>
</li>

                        
                            
<li >
    <a href="../../chapter4/exercise13/">4.13</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">5 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../exercise1/">5.1</a>
</li>

                        
                            
<li >
    <a href="../exercise2/">5.2</a>
</li>

                        
                            
<li >
    <a href="../exercise3/">5.3</a>
</li>

                        
                            
<li >
    <a href="../exercise4/">5.4</a>
</li>

                        
                            
<li class="active">
    <a href="./">5.5</a>
</li>

                        
                            
<li >
    <a href="../exercise6/">5.6</a>
</li>

                        
                            
<li >
    <a href="../exercise7/">5.7</a>
</li>

                        
                            
<li >
    <a href="../exercise8/">5.8</a>
</li>

                        
                            
<li >
    <a href="../exercise9/">5.9</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">6 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../chapter6/exercise1/">6.1</a>
</li>

                        
                            
<li >
    <a href="../../chapter6/exercise2/">6.2</a>
</li>

                        
                            
<li >
    <a href="../../chapter6/exercise3/">6.3</a>
</li>

                        
                            
<li >
    <a href="../../chapter6/exercise4/">6.4</a>
</li>

                        
                            
<li >
    <a href="../../chapter6/exercise5/">6.5</a>
</li>

                        
                            
<li >
    <a href="../../chapter6/exercise6/">6.6</a>
</li>

                        
                            
<li >
    <a href="../../chapter6/exercise7/">6.7</a>
</li>

                        
                            
<li >
    <a href="../../chapter6/exercise8/">6.8</a>
</li>

                        
                            
<li >
    <a href="../../chapter6/exercise9/">6.9</a>
</li>

                        
                            
<li >
    <a href="../../chapter6/exercise10/">6.10</a>
</li>

                        
                            
<li >
    <a href="../../chapter6/exercise11/">6.11</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">7 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../chapter7/exercise1/">7.1</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise2/">7.2</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise3/">7.3</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise4/">7.4</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise5/">7.5</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise6/">7.6</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise7/">7.7</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise8/">7.8</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise9/">7.9</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise10/">7.10</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise11/">7.11</a>
</li>

                        
                            
<li >
    <a href="../../chapter7/exercise12/">7.12</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">8 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../chapter8/exercise1/">8.1</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise2/">8.2</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise3/">8.3</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise4/">8.4</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise5/">8.5</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise6/">8.6</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise7/">8.7</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise8/">8.8</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise9/">8.9</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise10/">8.10</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise11/">8.11</a>
</li>

                        
                            
<li >
    <a href="../../chapter8/exercise12/">8.12</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">9 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../chapter9/exercise1/">9.1</a>
</li>

                        
                            
<li >
    <a href="../../chapter9/exercise2/">9.2</a>
</li>

                        
                            
<li >
    <a href="../../chapter9/exercise3/">9.3</a>
</li>

                        
                            
<li >
    <a href="../../chapter9/exercise4/">9.4</a>
</li>

                        
                            
<li >
    <a href="../../chapter9/exercise5/">9.5</a>
</li>

                        
                            
<li >
    <a href="../../chapter9/exercise6/">9.6</a>
</li>

                        
                            
<li >
    <a href="../../chapter9/exercise7/">9.7</a>
</li>

                        
                            
<li >
    <a href="../../chapter9/exercise8/">9.8</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">10 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../chapter10/exercise1/">10.1</a>
</li>

                        
                            
<li >
    <a href="../../chapter10/exercise2/">10.2</a>
</li>

                        
                            
<li >
    <a href="../../chapter10/exercise3/">10.3</a>
</li>

                        
                            
<li >
    <a href="../../chapter10/exercise4/">10.4</a>
</li>

                        
                            
<li >
    <a href="../../chapter10/exercise5/">10.5</a>
</li>

                        
                            
<li >
    <a href="../../chapter10/exercise6/">10.6</a>
</li>

                        
                            
<li >
    <a href="../../chapter10/exercise7/">10.7</a>
</li>

                        
                            
<li >
    <a href="../../chapter10/exercise8/">10.8</a>
</li>

                        
                            
<li >
    <a href="../../chapter10/exercise9/">10.9</a>
</li>

                        
                            
<li >
    <a href="../../chapter10/exercise10/">10.10</a>
</li>

                        
                            
<li >
    <a href="../../chapter10/exercise11/">10.11</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../../about/">About</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fa fa-search"></i> Search
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../exercise4/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../exercise6/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#exercise-55">Exercise 5.5</a></li>
            <li class="second-level"><a href="#a">(a)</a></li>
                
            <li class="second-level"><a href="#b">(b)</a></li>
                
            <li class="second-level"><a href="#i">i.</a></li>
                
            <li class="second-level"><a href="#ii">ii.</a></li>
                
            <li class="second-level"><a href="#iii">iii.</a></li>
                
            <li class="second-level"><a href="#iv">iv.</a></li>
                
            <li class="second-level"><a href="#c">(c)</a></li>
                
            <li class="second-level"><a href="#d">(d)</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="exercise-55">Exercise 5.5</h1>
<pre><code class="python">import pandas as pd
import numpy as np
import patsy
import seaborn as sns
import matplotlib.pyplot as plt

import statsmodels.formula.api as smf
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import confusion_matrix

# statsmodels issue: https://github.com/statsmodels/statsmodels/issues/3931
from scipy import stats
stats.chisqprob = lambda chisq, df: stats.chi2.sf(chisq, df)

sns.set(style=&quot;white&quot;)
%matplotlib inline
</code></pre>

<pre><code class="python">np.random.seed(1)

df = pd.read_csv(&quot;../data/Default.csv&quot;, index_col=0)

df['default_yes'] = (df['default'] == 'Yes').astype('int')
df.head()
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>default</th>
      <th>student</th>
      <th>balance</th>
      <th>income</th>
      <th>default_yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>No</td>
      <td>No</td>
      <td>729.526495</td>
      <td>44361.625074</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>No</td>
      <td>Yes</td>
      <td>817.180407</td>
      <td>12106.134700</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>No</td>
      <td>No</td>
      <td>1073.549164</td>
      <td>31767.138947</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>No</td>
      <td>No</td>
      <td>529.250605</td>
      <td>35704.493935</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>No</td>
      <td>No</td>
      <td>785.655883</td>
      <td>38463.495879</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<pre><code class="python">df.info()
</code></pre>

<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Int64Index: 10000 entries, 1 to 10000
Data columns (total 5 columns):
default        10000 non-null object
student        10000 non-null object
balance        10000 non-null float64
income         10000 non-null float64
default_yes    10000 non-null int64
dtypes: float64(2), int64(1), object(2)
memory usage: 468.8+ KB
</code></pre>
<h2 id="a">(a)</h2>
<p>We are looking for LogisticRegression without regularization. In sklearn this is not implemented, but we can use l2 regularization and set C, the inverese strenght, to a very high number, effectively removing the regularization. We also compare the coefficients to the ones obtained from statsmodel LogisticRegression which has no regularization, and we verify that the coefficient estimates match.</p>
<p>Another parameter we have to consider is the tolerance. In this case, the default 1e-4 is not enough to reach convergence, so we increased it until it did.</p>
<p>Below we that the coefficients obtained with sklearn agree with those from statsmodels.</p>
<pre><code class="python">lr = LogisticRegression(C=10**6, tol=1e-6)
X = df[['income', 'balance']]
y = df['default_yes']
mod = lr.fit(X, y)
mod.coef_
</code></pre>

<pre><code>array([[  2.07267113e-05,   5.64079143e-03]])
</code></pre>
<pre><code class="python">f = 'default_yes ~ income + balance'
res = smf.logit(formula=f, data=df).fit()
res.summary()
</code></pre>

<pre><code>Optimization terminated successfully.
         Current function value: 0.078948
         Iterations 10
</code></pre>
<table class="simpletable">
<caption>Logit Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>    <td>default_yes</td>   <th>  No. Observations:  </th>   <td> 10000</td>  
</tr>
<tr>
  <th>Model:</th>               <td>Logit</td>      <th>  Df Residuals:      </th>   <td>  9997</td>  
</tr>
<tr>
  <th>Method:</th>               <td>MLE</td>       <th>  Df Model:          </th>   <td>     2</td>  
</tr>
<tr>
  <th>Date:</th>          <td>Fri, 05 Jan 2018</td> <th>  Pseudo R-squ.:     </th>   <td>0.4594</td>  
</tr>
<tr>
  <th>Time:</th>              <td>16:05:52</td>     <th>  Log-Likelihood:    </th>  <td> -789.48</td> 
</tr>
<tr>
  <th>converged:</th>           <td>True</td>       <th>  LL-Null:           </th>  <td> -1460.3</td> 
</tr>
<tr>
  <th> </th>                      <td> </td>        <th>  LLR p-value:       </th> <td>4.541e-292</td>
</tr>
</table>

<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td>  -11.5405</td> <td>    0.435</td> <td>  -26.544</td> <td> 0.000</td> <td>  -12.393</td> <td>  -10.688</td>
</tr>
<tr>
  <th>income</th>    <td> 2.081e-05</td> <td> 4.99e-06</td> <td>    4.174</td> <td> 0.000</td> <td>  1.1e-05</td> <td> 3.06e-05</td>
</tr>
<tr>
  <th>balance</th>   <td>    0.0056</td> <td>    0.000</td> <td>   24.835</td> <td> 0.000</td> <td>    0.005</td> <td>    0.006</td>
</tr>
</table>

<h2 id="b">(b)</h2>
<h2 id="i">i.</h2>
<pre><code class="python">X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.5)
</code></pre>

<h2 id="ii">ii.</h2>
<pre><code class="python">mod = lr.fit(X_train, y_train)
mod.coef_
</code></pre>

<pre><code>array([[  1.62553551e-05,   5.83500517e-03]])
</code></pre>
<h2 id="iii">iii.</h2>
<p>Let's try to plot this region and boundary. For more info on how to draw the boundary for logistic regression, here's <a href="https://stackoverflow.com/a/28257799">two</a> <a href="https://stackoverflow.com/a/22356551">answers</a> by Michael Waskom, the creator of seaborn, and you can also see Jake VanderPlas' <a href="https://jakevdp.github.io/PythonDataScienceHandbook/04.04-density-and-contour-plots.html">book</a> for an introduction to contour plots in general.</p>
<pre><code class="python">xx, yy = np.mgrid[0:80000:100, -100:3000:10]
grid = np.c_[xx.ravel(), yy.ravel()]                    # https://www.quora.com/Can-anybody-elaborate-the-use-of-c_-in-numpy
probs = mod.predict_proba(grid)[:, 1].reshape(xx.shape)
</code></pre>

<pre><code class="python">f, ax = plt.subplots(figsize=(8,6))
contour = ax.contourf(xx, yy, probs, 25, cmap=&quot;RdBu&quot;,    # 25 levels
                     vmin=0, vmax=1)
ax_c = f.colorbar(contour)
ax_c.set_label(&quot;P(default)&quot;)
ax_c.set_ticks([0,0.25,0.5,.75,1])

ax.scatter(X_test['income'], X_test['balance'], c=y_test, s=50, 
          cmap=&quot;RdBu&quot;, vmin=-0.2, vmax=1.2,
          edgecolor=&quot;white&quot;, linewidth=1)

ax.set(xlabel=&quot;income&quot;, ylabel=&quot;balance&quot;);
</code></pre>

<p><img alt="png" src="../05_05_files/05_05_16_0.png" /></p>
<h2 id="iv">iv.</h2>
<pre><code class="python">y_pred = mod.predict(X_test)
1-(y_pred == y_test).mean()
</code></pre>

<pre><code>0.025000000000000022
</code></pre>
<p>So our general test error is 2.5%.</p>
<p>But from the figure above, it seems that the error rates are very different depending on whether we are considering a positive or a negative.
Let's have a look at the <a href="https://en.wikipedia.org/wiki/Confusion_matrix">confusion matrix</a> as well (page 145 of ISLR). 
The function show_confusion_matrix() we use below is from <a href="http://notmatthancock.github.io/2015/10/28/confusion-matrix.html">this blog post</a> by Matt Hancock (with a slight modification).</p>
<pre><code class="python">def show_confusion_matrix(C,class_labels=['0','1']):
    &quot;&quot;&quot;
    C: ndarray, shape (2,2) as given by scikit-learn confusion_matrix function
    class_labels: list of strings, default simply labels 0 and 1.

    Draws confusion matrix with associated metrics.
    &quot;&quot;&quot;
    import matplotlib.pyplot as plt
    import numpy as np

    assert C.shape == (2,2), &quot;Confusion matrix should be from binary classification only.&quot;

    # true negative, false positive, etc...
    tn = C[0,0]; fp = C[0,1]; fn = C[1,0]; tp = C[1,1];

    NP = fn+tp # Num positive examples
    NN = tn+fp # Num negative examples
    N  = NP+NN

    fig = plt.figure(figsize=(8,8))
    ax  = fig.add_subplot(111)
    ax.imshow(C, interpolation='nearest', cmap=plt.cm.gray)

    # Draw the grid boxes
    ax.set_xlim(-0.5,2.5)
    ax.set_ylim(2.5,-0.5)
    ax.plot([-0.5,2.5],[0.5,0.5], '-k', lw=2)
    ax.plot([-0.5,2.5],[1.5,1.5], '-k', lw=2)
    ax.plot([0.5,0.5],[-0.5,2.5], '-k', lw=2)
    ax.plot([1.5,1.5],[-0.5,2.5], '-k', lw=2)

    # Set xlabels
    ax.set_xlabel('Predicted Label', fontsize=16)
    ax.set_xticks([0,1,2])
    ax.set_xticklabels(class_labels + [''])
    ax.xaxis.set_label_position('top')
    ax.xaxis.tick_top()
    # These coordinate might require some tinkering. Ditto for y, below.
    ax.xaxis.set_label_coords(0.34,1.06)

    # Set ylabels
    ax.set_ylabel('True Label', fontsize=16, rotation=90)
    ax.set_yticklabels(class_labels + [''],rotation=90)
    ax.set_yticks([0,1,2])
    ax.yaxis.set_label_coords(-0.09,0.65)


    # Fill in initial metrics: tp, tn, etc...
    ax.text(0,0,
            'True Neg: %d\n(Num Neg: %d)'%(tn,NN),
            va='center',
            ha='center',
            bbox=dict(fc='w',boxstyle='round,pad=1'))

    ax.text(0,1,
            'False Neg: %d'%fn,
            va='center',
            ha='center',
            bbox=dict(fc='w',boxstyle='round,pad=1'))

    ax.text(1,0,
            'False Pos: %d'%fp,
            va='center',
            ha='center',
            bbox=dict(fc='w',boxstyle='round,pad=1'))


    ax.text(1,1,
            'True Pos: %d\n(Num Pos: %d)'%(tp,NP),
            va='center',
            ha='center',
            bbox=dict(fc='w',boxstyle='round,pad=1'))

    # Fill in secondary metrics: accuracy, true pos rate, etc...
    ax.text(2,0,
            'False Pos Rate: %.4f'%(fp / (fp+tn+0.)),
            va='center',
            ha='center',
            bbox=dict(fc='w',boxstyle='round,pad=1'))

    ax.text(2,1,
            'True Pos Rate: %.4f'%(tp / (tp+fn+0.)),
            va='center',
            ha='center',
            bbox=dict(fc='w',boxstyle='round,pad=1'))

    ax.text(2,2,
            'Accuracy: %.4f'%((tp+tn+0.)/N),
            va='center',
            ha='center',
            bbox=dict(fc='w',boxstyle='round,pad=1'))

    ax.text(0,2,
            'Neg Pre Val: %.4f'%(1-fn/(fn+tn+0.)),
            va='center',
            ha='center',
            bbox=dict(fc='w',boxstyle='round,pad=1'))

    ax.text(1,2,
            'Pos Pred Val: %.4f'%(tp/(tp+fp+0.)),
            va='center',
            ha='center',
            bbox=dict(fc='w',boxstyle='round,pad=1'))


    plt.tight_layout()
    plt.show()
</code></pre>

<pre><code class="python">C = confusion_matrix(y_test, y_pred)
show_confusion_matrix(C, ['No Default', 'Default'])
</code></pre>

<p><img alt="png" src="../05_05_files/05_05_21_0.png" /></p>
<p>Recall the definitions used in the <a href="https://en.wikipedia.org/wiki/Confusion_matrix">confusion matrix</a> above:
<em> P - condition positive (the number of real positive cases in the data)
</em> N - condition negative (the number of real negative cases in the data)
<em> TP - true positive (hit)
</em> TN - true negative (correct rejection)
<em> FP - false positive (false alarm, Type I error)
</em> FN - false negative (miss, Type II error)
<em> True positive rate, TPR = <span><span class="MathJax_Preview">\frac{TP}{P} = \frac{TP}{TP + FN}</span><script type="math/tex">\frac{TP}{P} = \frac{TP}{TP + FN}</script></span>
</em> False positive rate, FPR = <span><span class="MathJax_Preview">\frac{FP}{N} = \frac{FP}{FP + TN}</span><script type="math/tex">\frac{FP}{N} = \frac{FP}{FP + TN}</script></span>
<em> Positive predictive value, PPV = <span><span class="MathJax_Preview">\frac{TP}{TP + FP}</span><script type="math/tex">\frac{TP}{TP + FP}</script></span>
</em> Negative predictive value, NPV = <span><span class="MathJax_Preview">\frac{TN}{TN + FN}</span><script type="math/tex">\frac{TN}{TN + FN}</script></span>
* Accuracy, ACC = <span><span class="MathJax_Preview">\frac{TP + TN}{P+N} = \frac{TP+TN}{TP+TN+FP+FN}</span><script type="math/tex">\frac{TP + TN}{P+N} = \frac{TP+TN}{TP+TN+FP+FN}</script></span></p>
<p>So, our true positive rate (or sensitivity, recall or hit rate) is 0.3648, our false positive rate (or fall-out) is 0.0050, our positive predictive value (or precision) is 0.7073, our negative predictive value is 0.9795, and our accuracy is 0.9750.</p>
<h2 id="c">(c)</h2>
<p>Let's keep a vector of the confusion matrices, and compute the different errors for each validation set. </p>
<pre><code class="python">C = [C]
</code></pre>

<pre><code class="python">for i in range(1,4):
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.5)
    mod = lr.fit(X_train, y_train)
    y_pred = mod.predict(X_test)
    C.append(confusion_matrix(y_test, y_pred))
</code></pre>

<pre><code class="python">tpr, fpr, ppv, npv, acc = ([] for i in range(5))

for c in C:
    tn = c[0,0] 
    fp = c[0,1]
    fn = c[1,0]
    tp = c[1,1]
    tpr.append((tp / (tp+fn+0.)))
    fpr.append((fp / (fp+tn+0.)))
    ppv.append((tp/(tp+fp+0.)))
    npv.append((1-fn/(fn+tn+0.)))
    acc.append(((tp+tn+0.)/(tn+fp+fn+tp)))
</code></pre>

<pre><code class="python">def line(l):
    return &quot; &quot;.join( '{:06.4f}'.format(a) for a in l) + ', Average: ' +'{:06.4f}'.format(sum(l)/ len(l))

print('TPR: ')
print(line(tpr))
print('FPR: ')
print(line(fpr))
print('PPV: ')
print(line(ppv))
print('NPV: ')
print(line(npv))
print('ACC: ')
print(line(acc))
</code></pre>

<pre><code>TPR: 
0.3648 0.3452 0.3030 0.3293, Average: 0.3356
FPR: 
0.0050 0.0029 0.0041 0.0029, Average: 0.0037
PPV: 
0.7073 0.8056 0.7143 0.7941, Average: 0.7553
NPV: 
0.9795 0.9777 0.9767 0.9777, Average: 0.9779
ACC: 
0.9750 0.9752 0.9730 0.9752, Average: 0.9746
</code></pre>
<p>The values above indicate that some quantities vary more than others when we change the validation set. In particular, the positive predicted value (PPV) varies from 0.71 to 0.81. The PPV is the ratio of the true positives over the sum of the true positives and false positives. In other words, it's a ratio involving the quantities above the boundary in the region above. And since both these quantities vary significantly in this case, the variance of the PPV is expected. The accuracy on the other handle is much more robust across different validation sets, for the opposite reason. The quantities involved in its computation do not vary as much. The denominator is a constant, and the numerator, TP + TN, is somewhat stable, since TP and TN would on average vary in opposite directions.</p>
<h2 id="d">(d)</h2>
<pre><code class="python">df['student_yes'] = (df['student'] == 'Yes').astype('int')
</code></pre>

<pre><code class="python">df.head()
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>default</th>
      <th>student</th>
      <th>balance</th>
      <th>income</th>
      <th>default_yes</th>
      <th>student_yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>No</td>
      <td>No</td>
      <td>729.526495</td>
      <td>44361.625074</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>No</td>
      <td>Yes</td>
      <td>817.180407</td>
      <td>12106.134700</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>No</td>
      <td>No</td>
      <td>1073.549164</td>
      <td>31767.138947</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>No</td>
      <td>No</td>
      <td>529.250605</td>
      <td>35704.493935</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>No</td>
      <td>No</td>
      <td>785.655883</td>
      <td>38463.495879</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<pre><code class="python">X = df[['income','balance','student_yes']]
y = df['default_yes']

f = 'default_yes ~ income + balance + student_yes'

X_train, X_test, y_train, y_test = train_test_split(X, y)
train = X_train.join(y_train)


res = smf.logit(formula=f, data=train).fit()
res.summary()
</code></pre>

<pre><code>Optimization terminated successfully.
         Current function value: 0.076250
         Iterations 10
</code></pre>
<table class="simpletable">
<caption>Logit Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>    <td>default_yes</td>   <th>  No. Observations:  </th>   <td>  7500</td>  
</tr>
<tr>
  <th>Model:</th>               <td>Logit</td>      <th>  Df Residuals:      </th>   <td>  7496</td>  
</tr>
<tr>
  <th>Method:</th>               <td>MLE</td>       <th>  Df Model:          </th>   <td>     3</td>  
</tr>
<tr>
  <th>Date:</th>          <td>Fri, 05 Jan 2018</td> <th>  Pseudo R-squ.:     </th>   <td>0.4799</td>  
</tr>
<tr>
  <th>Time:</th>              <td>16:07:39</td>     <th>  Log-Likelihood:    </th>  <td> -571.88</td> 
</tr>
<tr>
  <th>converged:</th>           <td>True</td>       <th>  LL-Null:           </th>  <td> -1099.5</td> 
</tr>
<tr>
  <th> </th>                      <td> </td>        <th>  LLR p-value:       </th> <td>1.954e-228</td>
</tr>
</table>

<table class="simpletable">
<tr>
       <td></td>          <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>   <td>  -10.9255</td> <td>    0.579</td> <td>  -18.873</td> <td> 0.000</td> <td>  -12.060</td> <td>   -9.791</td>
</tr>
<tr>
  <th>income</th>      <td>-6.764e-06</td> <td>  9.4e-06</td> <td>   -0.720</td> <td> 0.472</td> <td>-2.52e-05</td> <td> 1.17e-05</td>
</tr>
<tr>
  <th>balance</th>     <td>    0.0061</td> <td>    0.000</td> <td>   21.174</td> <td> 0.000</td> <td>    0.006</td> <td>    0.007</td>
</tr>
<tr>
  <th>student_yes</th> <td>   -1.0870</td> <td>    0.274</td> <td>   -3.961</td> <td> 0.000</td> <td>   -1.625</td> <td>   -0.549</td>
</tr>
</table>

<pre><code class="python">y_pred = (res.predict(X_test) &gt; .5) * 1
</code></pre>

<pre><code class="python">C = confusion_matrix(y_test, y_pred)
show_confusion_matrix(C, ['No Default', 'Default'])
</code></pre>

<p><img alt="png" src="../05_05_files/05_05_35_0.png" /></p>
<p>So compared to the values above without the student dummy variable, it seems that adding the student variable does not help in any of the metrics since they are worse or very similar (although we should consider the variance, in a more careful analysis).  </p></div>
        
    </div>

    <footer class="col-md-12 text-center">
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
    </footer>

    <script src="../../../js/jquery-1.10.2.min.js"></script>
    <script src="../../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '../../..';
    </script>
    <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
    <script src="../../../js/base.js"></script>
    <script src="../../../mathjax-config.js"></script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../../../search/require.js"></script>
    <script src="../../../search/search.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
